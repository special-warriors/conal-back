<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <title>레포지토리 상세</title>
  <meta charset="UTF-8"/>
  <style>
    table {
      width: 100%;
    }

    th, td {
      padding: 8px;
      border: 1px solid #ccc;
    }
  </style>
</head>
<body>

<h1>레포지토리 상세</h1>
<div>
  <p><strong>레포 이름:</strong> <span th:text="${repoInfo.name}">repo-name</span></p>
  <p><strong>URL:</strong> <a th:href="${repoInfo.url}" th:text="${repoInfo.url}">repo-url</a></p>
  <p><strong>종료일:</strong> <span th:text="${repoInfo.endDate}">end-date</span></p>
</div>

<!-- 🔔 알림 설정 -->
<h2>알림 설정</h2>
<label>
  <input type="checkbox" id="vote-checkbox" onchange="toggleNotification('VOTE')"/>
  투표 알림
</label><br/>
<label>
  <input type="checkbox" id="contribution-checkbox" onchange="toggleNotification('CONTRIBUTION')"/>
  기여도 알림
</label><br/><br/>

<!-- 📊 기여자 기여도 -->
<h2>기여자 기여도</h2>
<button id="refreshBtn" onclick="refreshDetails()">기여도 업데이트</button>

<table>
  <thead>
  <tr>
    <th>기여자</th>
    <th>총점</th>
    <th>PR 수</th>
    <th>Issue 수</th>
    <th>Commit 수</th>
    <th>Merge된 PR 수</th>
  </tr>
  </thead>
  <tbody id="detail-body">
  <!-- JavaScript에서 동적으로 채움 -->
  </tbody>
</table>

<script th:inline="javascript">
  const owner = /*[[${repoInfo.owner}]]*/ "owner";
  const repo = /*[[${repoInfo.repo}]]*/ "repo";
  const userId = /*[[${repoInfo.userId}]]*/ 1;
  const repoId = /*[[${repoInfo.repoId}]]*/ 2;

  // 알림 상태 불러오기 (초기 세팅용)
  function loadNotificationStatus() {
    fetch(`/users/${userId}/repositories/${repoId}/notifications/status`)
    .then(response => response.json())
    .then(data => {
      document.getElementById('vote-checkbox').checked = data.vote;
      document.getElementById('contribution-checkbox').checked = data.contribution;
    })
    .catch(err => alert("알림 상태 불러오기 실패: " + err.message));
  }

  // 알림 상태 변경 요청
  function toggleNotification(type) {
    const isChecked = document.getElementById(
        type === 'VOTE' ? 'vote-checkbox' : 'contribution-checkbox'
    ).checked;

    fetch(`/users/${userId}/repositories/${repoId}/notifications`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        type: type,
        isAgree: isChecked
      })
    })
    .then(response => {
      if (!response.ok) {
        throw new Error("알림 설정 실패");
      }
    })
    .catch(err => alert("알림 설정 오류: " + err.message));
  }

  // 기여도 정보 조회
  function fetchDetails() {
    fetch(`/api/github/repos/${owner}/${repo}/details`)
    .then(response => response.json())
    .then(data => {
      const tbody = document.getElementById("detail-body");
      tbody.innerHTML = "";
      for (const contributor in data) {
        const detail = data[contributor];
        const row = `<tr>
            <td>${contributor}</td>
            <td>${detail.total}</td>
            <td>${detail.pr}</td>
            <td>${detail.issue}</td>
            <td>${detail.commit}</td>
            <td>${detail.mpr}</td>
          </tr>`;
        tbody.insertAdjacentHTML('beforeend', row);
      }
    })
    .catch(err => alert("기여도 조회 실패: " + err.message));
  }

  // 기여도 갱신
  function refreshDetails() {
    const refreshBtn = document.getElementById('refreshBtn');
    refreshBtn.disabled = true;
    refreshBtn.textContent = "3분 후 업데이트 가능";

    fetch(`/api/github/repos/${owner}/${repo}/update`, {method: 'POST'})
    .then(response => {
      if (!response.ok) {
        throw new Error("업데이트 실패");
      }
      return response.text();
    })
    .then(() => {
      setTimeout(fetchDetails, 2000);
      alert("기여도 업데이트가 완료되었습니다.");
    })
    .catch(err => {
      alert("기여도 업데이트 오류: " + err.message);
    })
    .finally(() => {
      setTimeout(() => {
        refreshBtn.disabled = false;
        refreshBtn.textContent = "기여도 업데이트";
      }, 180000);
    });
  }

  // 초기 실행
  window.onload = () => {
    fetchDetails();
    loadNotificationStatus();
  };
</script>

</body>
</html>
