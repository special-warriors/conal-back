<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <title>ë ˆí¬ì§€í† ë¦¬ ìƒì„¸</title>
  <meta charset="UTF-8"/>
  <style>
    table {
      width: 100%;
    }

    th, td {
      padding: 8px;
      border: 1px solid #ccc;
    }
  </style>
</head>
<body>

<h1>ë ˆí¬ì§€í† ë¦¬ ìƒì„¸</h1>
<div>
  <p><strong>ë ˆí¬ ì´ë¦„:</strong> <span th:text="${repoInfo.name}">repo-name</span></p>
  <p><strong>URL:</strong> <a th:href="${repoInfo.url}" th:text="${repoInfo.url}">repo-url</a></p>
  <p><strong>ì¢…ë£Œì¼:</strong> <span th:text="${repoInfo.endDate}">end-date</span></p>
</div>

<!-- ğŸ”” ì•Œë¦¼ ì„¤ì • -->
<h2>ì•Œë¦¼ ì„¤ì •</h2>
<label>
  <input type="checkbox" id="vote-checkbox" onchange="toggleNotification('VOTE')"/>
  íˆ¬í‘œ ì•Œë¦¼
</label><br/>
<label>
  <input type="checkbox" id="contribution-checkbox" onchange="toggleNotification('CONTRIBUTION')"/>
  ê¸°ì—¬ë„ ì•Œë¦¼
</label><br/><br/>

<!-- ğŸ“Š ê¸°ì—¬ì ê¸°ì—¬ë„ -->
<h2>ê¸°ì—¬ì ê¸°ì—¬ë„</h2>
<button id="refreshBtn" onclick="refreshDetails()">ê¸°ì—¬ë„ ì—…ë°ì´íŠ¸</button>

<table>
  <thead>
  <tr>
    <th>ê¸°ì—¬ì</th>
    <th>ì´ì </th>
    <th>PR ìˆ˜</th>
    <th>Issue ìˆ˜</th>
    <th>Commit ìˆ˜</th>
    <th>Mergeëœ PR ìˆ˜</th>
  </tr>
  </thead>
  <tbody id="detail-body">
  <!-- JavaScriptì—ì„œ ë™ì ìœ¼ë¡œ ì±„ì›€ -->
  </tbody>
</table>

<script th:inline="javascript">
  const owner = /*[[${repoInfo.owner}]]*/ "owner";
  const repo = /*[[${repoInfo.repo}]]*/ "repo";
  const userId = /*[[${repoInfo.userId}]]*/ 1;
  const repoId = /*[[${repoInfo.repoId}]]*/ 2;

  // ì•Œë¦¼ ìƒíƒœ ë¶ˆëŸ¬ì˜¤ê¸° (ì´ˆê¸° ì„¸íŒ…ìš©)
  function loadNotificationStatus() {
    fetch(`/users/${userId}/repositories/${repoId}/notifications/status`)
    .then(response => response.json())
    .then(data => {
      document.getElementById('vote-checkbox').checked = data.vote;
      document.getElementById('contribution-checkbox').checked = data.contribution;
    })
    .catch(err => alert("ì•Œë¦¼ ìƒíƒœ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: " + err.message));
  }

  // ì•Œë¦¼ ìƒíƒœ ë³€ê²½ ìš”ì²­
  function toggleNotification(type) {
    const isChecked = document.getElementById(
        type === 'VOTE' ? 'vote-checkbox' : 'contribution-checkbox'
    ).checked;

    fetch(`/users/${userId}/repositories/${repoId}/notifications`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        type: type,
        isAgree: isChecked
      })
    })
    .then(response => {
      if (!response.ok) {
        throw new Error("ì•Œë¦¼ ì„¤ì • ì‹¤íŒ¨");
      }
    })
    .catch(err => alert("ì•Œë¦¼ ì„¤ì • ì˜¤ë¥˜: " + err.message));
  }

  // ê¸°ì—¬ë„ ì •ë³´ ì¡°íšŒ
  function fetchDetails() {
    fetch(`/api/github/repos/${owner}/${repo}/details`)
    .then(response => response.json())
    .then(data => {
      const tbody = document.getElementById("detail-body");
      tbody.innerHTML = "";
      for (const contributor in data) {
        const detail = data[contributor];
        const row = `<tr>
            <td>${contributor}</td>
            <td>${detail.total}</td>
            <td>${detail.pr}</td>
            <td>${detail.issue}</td>
            <td>${detail.commit}</td>
            <td>${detail.mpr}</td>
          </tr>`;
        tbody.insertAdjacentHTML('beforeend', row);
      }
    })
    .catch(err => alert("ê¸°ì—¬ë„ ì¡°íšŒ ì‹¤íŒ¨: " + err.message));
  }

  // ê¸°ì—¬ë„ ê°±ì‹ 
  function refreshDetails() {
    const refreshBtn = document.getElementById('refreshBtn');
    refreshBtn.disabled = true;
    refreshBtn.textContent = "3ë¶„ í›„ ì—…ë°ì´íŠ¸ ê°€ëŠ¥";

    fetch(`/api/github/repos/${owner}/${repo}/update`, {method: 'POST'})
    .then(response => {
      if (!response.ok) {
        throw new Error("ì—…ë°ì´íŠ¸ ì‹¤íŒ¨");
      }
      return response.text();
    })
    .then(() => {
      setTimeout(fetchDetails, 2000);
      alert("ê¸°ì—¬ë„ ì—…ë°ì´íŠ¸ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
    })
    .catch(err => {
      alert("ê¸°ì—¬ë„ ì—…ë°ì´íŠ¸ ì˜¤ë¥˜: " + err.message);
    })
    .finally(() => {
      setTimeout(() => {
        refreshBtn.disabled = false;
        refreshBtn.textContent = "ê¸°ì—¬ë„ ì—…ë°ì´íŠ¸";
      }, 180000);
    });
  }

  // ì´ˆê¸° ì‹¤í–‰
  window.onload = () => {
    fetchDetails();
    loadNotificationStatus();
  };
</script>

</body>
</html>
